name: Deploy to jquiroz.net

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SITE_DIR: ${{ secrets.SITE_DIR }}
      PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
      GIT_REPO_URL: ${{ secrets.GIT_REPO_URL }}
      BRANCH: main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Deploy on server
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" "bash -s" << EOF
            set -e

            BASE_PATH="/home/${SSH_USER}/sites/${SITE_DIR}"
            PROJECT_PATH="\${BASE_PATH}/${PROJECT_DIR}"

            echo "=== Creando carpeta base si no existe: \$BASE_PATH ==="
            mkdir -p "\$BASE_PATH"

            echo "=== Entrando a carpeta del proyecto: \$PROJECT_PATH ==="
            mkdir -p "\$PROJECT_PATH"
            cd "\$PROJECT_PATH"

            if [ ! -d .git ]; then
              if [ -z "\$(ls -A .)" ]; then
                echo ">>> Primera vez: clonando ${GIT_REPO_URL}"
                git clone "${GIT_REPO_URL}" .
              else
                echo "ERROR: La carpeta \$PROJECT_PATH no está vacía y no es un repo git."
                exit 1
              fi
            else
              echo ">>> Repositorio ya existente, haciendo fetch..."
              git fetch --all
            fi

            LOCAL=\$(git rev-parse HEAD || echo "")
            REMOTE=\$(git rev-parse origin/${BRANCH} || echo "")

            if [ "\$LOCAL" != "\$REMOTE" ]; then
              echo ">>> Hay nueva versión, haciendo git pull..."
              git pull origin "${BRANCH}"

              if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
                echo ">>> Reiniciando contenedores..."
                docker compose down
                docker compose pull || true
                docker compose up -d --build
              else
                echo ">>> No hay docker-compose, solo se actualizaron archivos."
              fi
            else
              echo ">>> Todo está actualizado."
            fi

            echo "=== Despliegue completo ==="
          EOF

